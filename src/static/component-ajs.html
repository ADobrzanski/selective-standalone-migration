<!doctype html>
<head>
  <script src="./my-component.js" type="module"></script>
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
  ></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    .node circle {
      fill: #4287f5;
      stroke: steelblue;
      stroke-width: 3px;
      cursor: pointer;
    }
    .node text {
      font: 12px sans-serif;
    }
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
    }
  </style>
</head>
<body>
  <div
    x-data="{ id: searchParam('id'), component: null }"
    x-init="loadJSON(`/api/component/${id}`).then(set($data, 'component'))"
  >
    <div>
      <template x-if="component">
        <div>
          <h3 x-template>${component.name}</h3>
          <template x-if="!component.standalone">
            <button @click="fetch(`/migrate-single/${id}`)">
              Make standalone
            </button>
          </template>
          <ul>
            <li x-template>selector: ${component.selector}</li>
            <template x-if="component.standalone">
              <li x-template>standalone: ${component.standalone}</li>
            </template>
            <template x-if="component.declaredIn">
              <li x-template>declared in: ${component.declaredIn.name}</li>
            </template>
          </ul>
        </div>
      </template>
      <template x-if="!component">
        <div>Loading component...</div>
      </template>
    </div>

    <div
      x-data="{ data: [], tree: null }"
      x-init="loadJSON(`/api/component/${id}/dependency`).then(set($data, 'data'))"
      x-effect="data?.length && component.id && set($data, 'tree')(createDependencyTreeNodes(component, data))"
    >
      <details>
        <summary x-template>Template dependecies (${data?.length})</summary>

        <ul>
          <template x-for="d in data">
            <li>
              <span x-html="d.name"></span>
              <template x-if="d.standalone">
                <span>(standalone)</span>
              </template>
              <template x-if="d.declaredIn">
                <span>(<span x-html="d.declaredIn.name"></span>)</span>
              </template>
            </li>
          </template>
        </ul>
      </details>

      <template x-if="tree">
        <my-chart
          :data="JSON.stringify(tree)"
          @node-super-click="expandDependencyTree($event.detail, $data)"
        ></my-chart>
      </template>
    </div>
  </div>

  <script>
    // alpine.js utils
    function searchParam(name) {
      return new URLSearchParams(document.location.search).get(name);
    }

    function loadJSON(url) {
      return fetch(url).then((_) => _.json());
    }

    function set(obj, propertyName) {
      return (data) => {
        obj[propertyName] = data;
        return data;
      };
    }

    // dependency tree helpers
    function randomId() {
      return Math.random().toString().slice(2);
    }

    function createDependencyTreeNodes(root, data) {
      const deps = [...data];

      const modules = [];

      const standaloneModule = {
        id: randomId(),
        parentId: root.id,
        name: "standalone",
      };

      deps.forEach((d) => {
        if (d.id === -1) {
          d.id = randomId();
        }

        if (d.declaredIn) {
          d.parentId = `${root.id}-${d.declaredIn.id}`;

          if (!modules.find((_) => _.id === d.parentId)) {
            modules.push({
              ...d.declaredIn,
              id: d.parentId,
              parentId: root.id,
            });
          }
        } else {
          d.parentId = standaloneModule.id;

          if (!modules.find((_) => _.id === standaloneModule.id)) {
            modules.push(standaloneModule);
          }
        }
      });

      return [root, ...deps, ...modules];
    }

    async function expandDependencyTree(event, data) {
      try {
        const depsResponse = await fetch(
          `/api/component/${event.id}/dependency`,
        );
        const responseData = await depsResponse.json();

        if (!depsResponse.ok) throw new Error(JSON.stringify(responseData));

        const subTree = createDependencyTreeNodes(event, responseData).filter(
          (_) => _.id !== event.id,
        );
        data.tree.push(...subTree);
      } catch (e) {
        alert(e);
      }
    }

    document.addEventListener("alpine:init", () => {
      Alpine.directive("template", (el, _, { effect, evaluateLater }) => {
        let evaluate = evaluateLater("`" + el.innerText + "`");

        effect(() => {
          evaluate((value) => {
            el.textContent = value;
          });
        });
      });
    });
  </script>
</body>
